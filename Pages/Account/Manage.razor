@page "/Account/Manage"
@page "/profile"
@page "/settings"
@attribute [Authorize]
@inject UserManager<ApplicationUser> UserManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject NotificationService NotificationService
@inject NavigationManager Navigation
@inject SignInManager<ApplicationUser> SignInManager

<PageTitle>Account Settings - PeP v5.0</PageTitle>

<RadzenStack Gap="0.75rem" Style="max-width:1400px;margin:0 auto;">
    <RadzenBreadCrumb>
        <RadzenBreadCrumbItem Path="/" Text="Home" Icon="home" />
        <RadzenBreadCrumbItem Text="Account Settings" Icon="manage_accounts" />
    </RadzenBreadCrumb>

    @if (isLoading)
    {
        <RadzenCard Style="padding:2rem;">
            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center" Gap="1rem">
                <RadzenProgressBarCircular ShowValue="false" Size="ProgressBarCircularSize.Medium" />
                <RadzenText TextStyle="TextStyle.Body1">Loading your profile...</RadzenText>
            </RadzenStack>
        </RadzenCard>
    }
    else if (!string.IsNullOrEmpty(loadError))
    {
        <RadzenCard Style="padding:1.25rem;">
            <RadzenStack Gap="1rem">
                <RadzenAlert AlertStyle="AlertStyle.Danger" Icon="error" AllowClose="false">
                    @loadError
                </RadzenAlert>
                <RadzenButton Text="Back to Dashboard" Icon="arrow_back" ButtonStyle="ButtonStyle.Primary" Click="@(() => Navigation.NavigateTo("/"))" />
            </RadzenStack>
        </RadzenCard>
    }
    else if (currentUser != null)
    {
        <RadzenCard Style="padding:1.25rem;">
            <RadzenStack Gap="0.5rem" Style="margin-bottom:1rem;">
                <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                    <RadzenIcon Icon="manage_accounts" Style="font-size:2rem;color:var(--rz-primary);" />
                    <RadzenText TextStyle="TextStyle.H4" TagName="TagName.H1" Style="margin:0;">Account Settings</RadzenText>
                </RadzenStack>
                <RadzenText TextStyle="TextStyle.Body2" class="text-muted">Manage your personal information and account security.</RadzenText>
            </RadzenStack>

            <RadzenTabs>
                <Tabs>
                    <!-- Profile Tab -->
                    <RadzenTabsItem Text="Profile" Icon="person">
                        <RadzenRow Style="row-gap:1rem;margin-top:1rem;">
                            <RadzenColumn Size="12" SizeLG="8">
                                <RadzenTemplateForm TItem="ManageProfileModel" Data="@profileModel" Submit="@SaveProfile">
                                    <RadzenStack Gap="1rem">
                                        <!-- Personal Information Card -->
                                        <RadzenCard Style="background:var(--rz-base-100);">
                                            <RadzenStack Gap="0.75rem">
                                                <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                                                    <RadzenIcon Icon="badge" Style="color:var(--rz-info);" />
                                                    <RadzenText TextStyle="TextStyle.H6" Style="margin:0;">Personal Information</RadzenText>
                                                </RadzenStack>

                                                <RadzenRow Style="row-gap:0.75rem;">
                                                    <RadzenColumn Size="12" SizeMD="6">
                                                        <RadzenFormField Text="First Name" Variant="Variant.Outlined" Style="width:100%;">
                                                            <RadzenTextBox @bind-Value="@profileModel.FirstName" Name="FirstName" Style="width:100%;" />
                                                            <RadzenRequiredValidator Component="FirstName" Text="First name is required" />
                                                        </RadzenFormField>
                                                    </RadzenColumn>
                                                    <RadzenColumn Size="12" SizeMD="6">
                                                        <RadzenFormField Text="Last Name" Variant="Variant.Outlined" Style="width:100%;">
                                                            <RadzenTextBox @bind-Value="@profileModel.LastName" Name="LastName" Style="width:100%;" />
                                                            <RadzenRequiredValidator Component="LastName" Text="Last name is required" />
                                                        </RadzenFormField>
                                                    </RadzenColumn>
                                                    <RadzenColumn Size="12" SizeMD="6">
                                                        <RadzenFormField Text="Email Address" Variant="Variant.Outlined" Style="width:100%;">
                                                            <ChildContent>
                                                                <RadzenTextBox Value="@profileModel.Email" Name="Email" Disabled="true" Style="width:100%;" />
                                                            </ChildContent>
                                                            <Helper>
                                                                <RadzenText TextStyle="TextStyle.Caption" class="text-muted">Email cannot be changed</RadzenText>
                                                            </Helper>
                                                        </RadzenFormField>
                                                    </RadzenColumn>
                                                    <RadzenColumn Size="12" SizeMD="6">
                                                        <RadzenFormField Text="Phone Number" Variant="Variant.Outlined" Style="width:100%;">
                                                            <RadzenTextBox @bind-Value="@profileModel.PhoneNumber" Name="Phone" Style="width:100%;" Placeholder="Optional" />
                                                        </RadzenFormField>
                                                    </RadzenColumn>
                                                </RadzenRow>
                                            </RadzenStack>
                                        </RadzenCard>

                                        <!-- Academic Information Card -->
                                        <RadzenCard Style="background:var(--rz-base-100);">
                                            <RadzenStack Gap="0.75rem">
                                                <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                                                    <RadzenIcon Icon="school" Style="color:var(--rz-secondary);" />
                                                    <RadzenText TextStyle="TextStyle.H6" Style="margin:0;">Academic Information</RadzenText>
                                                </RadzenStack>

                                                <RadzenRow Style="row-gap:0.75rem;">
                                                    <RadzenColumn Size="12" SizeMD="6">
                                                        <RadzenFormField Text="Student ID" Variant="Variant.Outlined" Style="width:100%;">
                                                            <RadzenTextBox @bind-Value="@profileModel.StudentId" Name="StudentId" Style="width:100%;" Placeholder="Enter your student ID" />
                                                        </RadzenFormField>
                                                    </RadzenColumn>
                                                    <RadzenColumn Size="12" SizeMD="6">
                                                        <RadzenFormField Text="Department" Variant="Variant.Outlined" Style="width:100%;">
                                                            <RadzenTextBox @bind-Value="@profileModel.Department" Name="Department" Style="width:100%;" Placeholder="e.g. Computer Science" />
                                                        </RadzenFormField>
                                                    </RadzenColumn>
                                                </RadzenRow>
                                            </RadzenStack>
                                        </RadzenCard>

                                        @if (!string.IsNullOrEmpty(profileError))
                                        {
                                            <RadzenAlert AlertStyle="AlertStyle.Danger" Icon="error" AllowClose="false">
                                                @profileError
                                            </RadzenAlert>
                                        }

                                        <!-- Action Bar -->
                                        <RadzenCard Style="background:var(--rz-base-200);padding:1rem;">
                                            <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.End">
                                                <RadzenButton ButtonType="ButtonType.Submit" Text="Save Profile" Icon="save" 
                                                             ButtonStyle="ButtonStyle.Primary" Size="ButtonSize.Medium"
                                                             Disabled="@isSavingProfile" IsBusy="@isSavingProfile" />
                                            </RadzenStack>
                                        </RadzenCard>
                                    </RadzenStack>
                                </RadzenTemplateForm>
                            </RadzenColumn>

                            <RadzenColumn Size="12" SizeLG="4">
                                <!-- Account Status Card -->
                                <RadzenCard Style="background:linear-gradient(135deg, var(--rz-primary-lighter) 0%, var(--rz-info-lighter) 100%);height:100%;">
                                    <RadzenStack Gap="1rem">
                                        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                                            <RadzenIcon Icon="verified_user" Style="font-size:1.5rem;color:var(--rz-primary);" />
                                            <RadzenText TextStyle="TextStyle.H6" Style="margin:0;">Account Status</RadzenText>
                                        </RadzenStack>

                                        <RadzenStack Gap="0.75rem">
                                            <RadzenCard Style="background:rgba(255,255,255,0.8);padding:0.75rem;">
                                                <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center">
                                                    <RadzenText TextStyle="TextStyle.Body2" Style="margin:0;">Status</RadzenText>
                                                    <RadzenBadge Text="@(currentUser.IsActive ? "Active" : "Inactive")" 
                                                                BadgeStyle="@(currentUser.IsActive ? BadgeStyle.Success : BadgeStyle.Danger)" />
                                                </RadzenStack>
                                            </RadzenCard>
                                            
                                            <RadzenCard Style="background:rgba(255,255,255,0.8);padding:0.75rem;">
                                                <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center">
                                                    <RadzenText TextStyle="TextStyle.Body2" Style="margin:0;">Member Since</RadzenText>
                                                    <RadzenText TextStyle="TextStyle.Caption" Style="margin:0;font-weight:500;">@currentUser.CreatedAt.ToString("MMM dd, yyyy")</RadzenText>
                                                </RadzenStack>
                                            </RadzenCard>
                                            
                                            @if (userRoles.Any())
                                            {
                                                <RadzenCard Style="background:rgba(255,255,255,0.8);padding:0.75rem;">
                                                    <RadzenStack Gap="0.5rem">
                                                        <RadzenText TextStyle="TextStyle.Body2" Style="margin:0;">Roles</RadzenText>
                                                        <RadzenStack Orientation="Orientation.Horizontal" Gap="0.25rem" Wrap="FlexWrap.Wrap">
                                                            @foreach (var role in userRoles)
                                                            {
                                                                <RadzenBadge Text="@role" BadgeStyle="BadgeStyle.Primary" />
                                                            }
                                                        </RadzenStack>
                                                    </RadzenStack>
                                                </RadzenCard>
                                            }
                                        </RadzenStack>

                                        <RadzenAlert AlertStyle="AlertStyle.Info" Icon="info" Shade="Shade.Lighter" AllowClose="false">
                                            <RadzenText TextStyle="TextStyle.Caption">
                                                Contact your administrator if you need to change your email or role.
                                            </RadzenText>
                                        </RadzenAlert>
                                    </RadzenStack>
                                </RadzenCard>
                            </RadzenColumn>
                        </RadzenRow>
                    </RadzenTabsItem>

                    <!-- Security Tab -->
                    <RadzenTabsItem Text="Security" Icon="security">
                        <RadzenRow Style="row-gap:1rem;margin-top:1rem;">
                            <RadzenColumn Size="12" SizeLG="8">
                                <RadzenTemplateForm TItem="ChangePasswordModel" Data="@passwordModel" Submit="@ChangePassword">
                                    <RadzenStack Gap="1rem">
                                        <RadzenCard Style="background:var(--rz-base-100);">
                                            <RadzenStack Gap="0.75rem">
                                                <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                                                    <RadzenIcon Icon="lock" Style="color:var(--rz-warning);" />
                                                    <RadzenText TextStyle="TextStyle.H6" Style="margin:0;">Change Password</RadzenText>
                                                </RadzenStack>

                                                <RadzenAlert AlertStyle="AlertStyle.Info" Icon="info" Shade="Shade.Lighter" AllowClose="false">
                                                    <RadzenText TextStyle="TextStyle.Body2">
                                                        Choose a strong password with at least 8 characters including uppercase, lowercase, numbers, and symbols.
                                                    </RadzenText>
                                                </RadzenAlert>

                                                <RadzenRow Style="row-gap:0.75rem;">
                                                    <RadzenColumn Size="12">
                                                        <RadzenFormField Text="Current Password" Variant="Variant.Outlined" Style="width:100%;">
                                                            <RadzenPassword @bind-Value="@passwordModel.CurrentPassword" Name="CurrentPassword" Style="width:100%;" />
                                                            <RadzenRequiredValidator Component="CurrentPassword" Text="Current password is required" />
                                                        </RadzenFormField>
                                                    </RadzenColumn>
                                                    <RadzenColumn Size="12" SizeMD="6">
                                                        <RadzenFormField Text="New Password" Variant="Variant.Outlined" Style="width:100%;">
                                                            <RadzenPassword @bind-Value="@passwordModel.NewPassword" Name="NewPassword" Style="width:100%;" />
                                                            <RadzenRequiredValidator Component="NewPassword" Text="New password is required" />
                                                        </RadzenFormField>
                                                    </RadzenColumn>
                                                    <RadzenColumn Size="12" SizeMD="6">
                                                        <RadzenFormField Text="Confirm New Password" Variant="Variant.Outlined" Style="width:100%;">
                                                            <RadzenPassword @bind-Value="@passwordModel.ConfirmPassword" Name="ConfirmPassword" Style="width:100%;" />
                                                            <RadzenRequiredValidator Component="ConfirmPassword" Text="Please confirm the new password" />
                                                            <RadzenCompareValidator Component="ConfirmPassword" Value="@passwordModel.NewPassword" Text="Passwords must match" />
                                                        </RadzenFormField>
                                                    </RadzenColumn>
                                                </RadzenRow>
                                            </RadzenStack>
                                        </RadzenCard>

                                        @if (!string.IsNullOrEmpty(passwordError))
                                        {
                                            <RadzenAlert AlertStyle="AlertStyle.Danger" Icon="error" AllowClose="false">
                                                @passwordError
                                            </RadzenAlert>
                                        }

                                        <!-- Action Bar -->
                                        <RadzenCard Style="background:var(--rz-base-200);padding:1rem;">
                                            <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.End">
                                                <RadzenButton ButtonType="ButtonType.Submit" Text="Update Password" Icon="password" 
                                                             ButtonStyle="ButtonStyle.Warning" Size="ButtonSize.Medium"
                                                             Disabled="@isSavingPassword" IsBusy="@isSavingPassword" />
                                            </RadzenStack>
                                        </RadzenCard>
                                    </RadzenStack>
                                </RadzenTemplateForm>
                            </RadzenColumn>

                            <RadzenColumn Size="12" SizeLG="4">
                                <RadzenCard Style="background:linear-gradient(135deg, var(--rz-warning-lighter) 0%, var(--rz-danger-lighter) 100%);height:100%;">
                                    <RadzenStack Gap="1rem">
                                        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                                            <RadzenIcon Icon="tips_and_updates" Style="font-size:1.5rem;color:var(--rz-warning-dark);" />
                                            <RadzenText TextStyle="TextStyle.H6" Style="margin:0;">Password Tips</RadzenText>
                                        </RadzenStack>

                                        <RadzenStack Gap="0.5rem">
                                            <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" AlignItems="AlignItems.Start">
                                                <RadzenIcon Icon="check_circle" Style="color:var(--rz-success);font-size:1rem;" />
                                                <RadzenText TextStyle="TextStyle.Body2">Use at least 8 characters</RadzenText>
                                            </RadzenStack>
                                            <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" AlignItems="AlignItems.Start">
                                                <RadzenIcon Icon="check_circle" Style="color:var(--rz-success);font-size:1rem;" />
                                                <RadzenText TextStyle="TextStyle.Body2">Include uppercase and lowercase letters</RadzenText>
                                            </RadzenStack>
                                            <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" AlignItems="AlignItems.Start">
                                                <RadzenIcon Icon="check_circle" Style="color:var(--rz-success);font-size:1rem;" />
                                                <RadzenText TextStyle="TextStyle.Body2">Add numbers and special characters</RadzenText>
                                            </RadzenStack>
                                            <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" AlignItems="AlignItems.Start">
                                                <RadzenIcon Icon="check_circle" Style="color:var(--rz-success);font-size:1rem;" />
                                                <RadzenText TextStyle="TextStyle.Body2">Avoid common words or patterns</RadzenText>
                                            </RadzenStack>
                                            <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" AlignItems="AlignItems.Start">
                                                <RadzenIcon Icon="check_circle" Style="color:var(--rz-success);font-size:1rem;" />
                                                <RadzenText TextStyle="TextStyle.Body2">Don't reuse passwords</RadzenText>
                                            </RadzenStack>
                                        </RadzenStack>

                                        <RadzenAlert AlertStyle="AlertStyle.Warning" Icon="warning" Shade="Shade.Lighter" AllowClose="false">
                                            <RadzenText TextStyle="TextStyle.Caption">
                                                Never share your password with anyone, including administrators.
                                            </RadzenText>
                                        </RadzenAlert>
                                    </RadzenStack>
                                </RadzenCard>
                            </RadzenColumn>
                        </RadzenRow>
                    </RadzenTabsItem>
                </Tabs>
            </RadzenTabs>
        </RadzenCard>
    }
</RadzenStack>

@code {
    private ManageProfileModel profileModel = new();
    private ChangePasswordModel passwordModel = new();
    private ApplicationUser? currentUser;
    private List<string> userRoles = new();
    private string? loadError;
    private string? profileError;
    private string? passwordError;
    private bool isLoading = true;
    private bool isSavingProfile;
    private bool isSavingPassword;

    protected override async Task OnInitializedAsync()
    {
        await LoadUserAsync();
    }

    private async Task LoadUserAsync()
    {
        isLoading = true;
        loadError = null;

        try
        {
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            if (authState?.User?.Identity?.IsAuthenticated == true)
            {
                var userId = UserManager.GetUserId(authState.User);
                if (!string.IsNullOrEmpty(userId))
                {
                    currentUser = await UserManager.FindByIdAsync(userId);
                    if (currentUser != null)
                    {
                        profileModel = new ManageProfileModel
                        {
                            FirstName = currentUser.FirstName,
                            LastName = currentUser.LastName,
                            Email = currentUser.Email ?? string.Empty,
                            PhoneNumber = currentUser.PhoneNumber ?? string.Empty,
                            StudentId = currentUser.StudentId,
                            Department = currentUser.Department
                        };

                        userRoles = (await UserManager.GetRolesAsync(currentUser)).ToList();
                    }
                    else
                    {
                        loadError = "We could not find your user record.";
                    }
                }
                else
                {
                    loadError = "Unable to determine the current user.";
                }
            }
            else
            {
                loadError = "You need to be signed in to view this page.";
            }
        }
        catch (Exception ex)
        {
            loadError = "An error occurred while loading your profile.";
            Console.WriteLine($"Profile load error: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task SaveProfile()
    {
        if (currentUser == null) return;

        isSavingProfile = true;
        profileError = null;

        try
        {
            currentUser.FirstName = profileModel.FirstName.Trim();
            currentUser.LastName = profileModel.LastName.Trim();
            currentUser.PhoneNumber = profileModel.PhoneNumber?.Trim();
            currentUser.StudentId = string.IsNullOrWhiteSpace(profileModel.StudentId) ? null : profileModel.StudentId.Trim();
            currentUser.Department = string.IsNullOrWhiteSpace(profileModel.Department) ? null : profileModel.Department.Trim();

            var result = await UserManager.UpdateAsync(currentUser);
            if (result.Succeeded)
            {
                NotificationService.Notify(NotificationSeverity.Success, "Saved", "Your profile was updated.");
            }
            else
            {
                profileError = string.Join("; ", result.Errors.Select(e => e.Description));
            }
        }
        catch (Exception ex)
        {
            profileError = "Could not save your changes right now.";
            Console.WriteLine($"Profile save error: {ex.Message}");
        }
        finally
        {
            isSavingProfile = false;
        }
    }

    private async Task ChangePassword()
    {
        if (currentUser == null) return;

        passwordError = null;
        isSavingPassword = true;

        try
        {
            if (passwordModel.NewPassword != passwordModel.ConfirmPassword)
            {
                passwordError = "New passwords do not match.";
                return;
            }

            var result = await UserManager.ChangePasswordAsync(currentUser, passwordModel.CurrentPassword, passwordModel.NewPassword);
            if (result.Succeeded)
            {
                NotificationService.Notify(NotificationSeverity.Success, "Password Updated", "Your password has been changed.");
                await SignInManager.RefreshSignInAsync(currentUser);
                passwordModel = new ChangePasswordModel();
            }
            else
            {
                passwordError = string.Join("; ", result.Errors.Select(e => e.Description));
            }
        }
        catch (Exception ex)
        {
            passwordError = "Could not update your password right now.";
            Console.WriteLine($"Password change error: {ex.Message}");
        }
        finally
        {
            isSavingPassword = false;
        }
    }

    private class ManageProfileModel
    {
        public string FirstName { get; set; } = string.Empty;
        public string LastName { get; set; } = string.Empty;
        public string Email { get; set; } = string.Empty;
        public string? PhoneNumber { get; set; }
        public string? StudentId { get; set; }
        public string? Department { get; set; }
    }

    private class ChangePasswordModel
    {
        public string CurrentPassword { get; set; } = string.Empty;
        public string NewPassword { get; set; } = string.Empty;
        public string ConfirmPassword { get; set; } = string.Empty;
    }
}
