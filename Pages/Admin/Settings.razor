@page "/admin/settings"
@attribute [Authorize(Roles = UserRoles.Admin)]
@inject ApplicationDbContext Context
@inject NotificationService NotificationService
@inject DialogService DialogService

<PageTitle>Platform Settings - PeP v5.0</PageTitle>

<RadzenStack Gap="0.75rem" Style="max-width:1400px;margin:0 auto;">
    <RadzenBreadCrumb>
        <RadzenBreadCrumbItem Path="/" Text="Home" Icon="home" />
        <RadzenBreadCrumbItem Text="Platform Settings" Icon="settings" />
    </RadzenBreadCrumb>

    <RadzenCard Style="padding:1.25rem;">
        <RadzenStack Gap="0.5rem" Style="margin-bottom:1rem;">
            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                <RadzenIcon Icon="settings" Style="font-size:2rem;color:var(--rz-primary);" />
                <RadzenText TextStyle="TextStyle.H4" TagName="TagName.H1" Style="margin:0;">Platform Settings</RadzenText>
            </RadzenStack>
            <RadzenText TextStyle="TextStyle.Body2" class="text-muted">Configure global platform, integration, and default exam settings.</RadzenText>
        </RadzenStack>

        <RadzenTemplateForm Data="@model" TItem="SettingsModel" Submit="@OnSave">
            <RadzenTabs>
                <Tabs>
                    <!-- Platform Tab -->
                    <RadzenTabsItem Text="Platform" Icon="info">
                        <RadzenRow Style="row-gap:1rem;margin-top:1rem;">
                            <RadzenColumn Size="12" SizeMD="6">
                                <RadzenCard Style="height:100%;background:var(--rz-base-100);">
                                    <RadzenStack Gap="0.75rem">
                                        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                                            <RadzenIcon Icon="apartment" Style="color:var(--rz-info);" />
                                            <RadzenText TextStyle="TextStyle.H6" Style="margin:0;">Platform Information</RadzenText>
                                        </RadzenStack>

                                        <RadzenFormField Text="Platform Name" Variant="Variant.Outlined" Style="width:100%;">
                                            <RadzenTextBox @bind-Value="model.PlatformName" Name="PlatformName" MaxLength="200" 
                                                          Placeholder="e.g. PeP - Programming Examination Platform" Style="width:100%;" />
                                            <RadzenRequiredValidator Component="PlatformName" Text="Platform name is required" />
                                        </RadzenFormField>

                                        <RadzenFormField Text="Version" Variant="Variant.Outlined" Style="width:100%;">
                                            <RadzenTextBox @bind-Value="model.Version" Name="Version" MaxLength="50" 
                                                          Placeholder="e.g. 5.0" Style="width:100%;" />
                                        </RadzenFormField>

                                        <RadzenFormField Text="Company Name" Variant="Variant.Outlined" Style="width:100%;">
                                            <RadzenTextBox @bind-Value="model.CompanyName" Name="CompanyName" MaxLength="200" 
                                                          Placeholder="e.g. Infinity Atom" Style="width:100%;" />
                                        </RadzenFormField>

                                        <RadzenFormField Text="Copyright" Variant="Variant.Outlined" Style="width:100%;">
                                            <RadzenTextBox @bind-Value="model.Copyright" Name="Copyright" MaxLength="150" 
                                                          Placeholder="e.g. Copyright 2021 - 2025" Style="width:100%;" />
                                        </RadzenFormField>
                                    </RadzenStack>
                                </RadzenCard>
                            </RadzenColumn>

                            <RadzenColumn Size="12" SizeMD="6">
                                <RadzenCard Style="height:100%;background:var(--rz-base-100);">
                                    <RadzenStack Gap="0.75rem">
                                        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                                            <RadzenIcon Icon="tune" Style="color:var(--rz-secondary);" />
                                            <RadzenText TextStyle="TextStyle.H6" Style="margin:0;">Default Settings</RadzenText>
                                        </RadzenStack>

                                        <RadzenFormField Text="Default Exam Duration (Minutes)" Variant="Variant.Outlined" Style="width:100%;">
                                            <RadzenNumeric @bind-Value="model.DefaultExamDurationMinutes" Name="DefaultExamDuration" 
                                                          Min="1" Max="600" Style="width:100%;" />
                                            <RadzenRequiredValidator Component="DefaultExamDuration" Text="Duration is required" />
                                        </RadzenFormField>

                                        <RadzenAlert AlertStyle="AlertStyle.Info" Icon="info" Shade="Shade.Lighter" AllowClose="false">
                                            <RadzenText TextStyle="TextStyle.Body2">
                                                This value will be applied automatically when creating new exams.
                                            </RadzenText>
                                        </RadzenAlert>
                                    </RadzenStack>
                                </RadzenCard>
                            </RadzenColumn>
                        </RadzenRow>
                    </RadzenTabsItem>

                    <!-- AI Integration Tab -->
                    <RadzenTabsItem Text="AI Integration" Icon="smart_toy">
                        <RadzenRow Style="row-gap:1rem;margin-top:1rem;">
                            <RadzenColumn Size="12" SizeLG="8">
                                <RadzenCard Style="background:var(--rz-base-100);">
                                    <RadzenStack Gap="0.75rem">
                                        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                                            <RadzenIcon Icon="smart_toy" Style="color:var(--rz-primary);" />
                                            <RadzenText TextStyle="TextStyle.H6" Style="margin:0;">OpenAI Configuration</RadzenText>
                                        </RadzenStack>

                                        <RadzenAlert AlertStyle="AlertStyle.Info" Icon="info" Shade="Shade.Lighter" AllowClose="false">
                                            <RadzenText TextStyle="TextStyle.Body2">
                                                The OpenAI API is used to generate exam questions automatically. Your API key is stored securely.
                                            </RadzenText>
                                        </RadzenAlert>

                                        <RadzenFormField Text="OpenAI API Key" Variant="Variant.Outlined" Style="width:100%;">
                                            <ChildContent>
                                                <RadzenPassword @bind-Value="model.OpenAIApiKey" Name="OpenAIApiKey" 
                                                               Placeholder="sk-..." Style="width:100%;" />
                                            </ChildContent>
                                        </RadzenFormField>
                                        <RadzenRequiredValidator Component="OpenAIApiKey" Text="API key is required for AI features" />

                                        <RadzenStack Orientation="Orientation.Horizontal" Gap="0.75rem" AlignItems="AlignItems.Center">
                                            <RadzenButton Text="Test Connection" Icon="wifi" ButtonStyle="ButtonStyle.Info" 
                                                         Size="ButtonSize.Medium" Click="@TestOpenAI" 
                                                         Disabled="@DisableOpenAiTest" IsBusy="@isTestingOpenAi" />
                                            @if (openAiTestStatus != null)
                                            {
                                                <RadzenBadge Text="@openAiTestStatus" BadgeStyle="@openAiTestStyle" />
                                            }
                                        </RadzenStack>
                                    </RadzenStack>
                                </RadzenCard>
                            </RadzenColumn>

                            <RadzenColumn Size="12" SizeLG="4">
                                <RadzenCard Style="background:linear-gradient(135deg, var(--rz-info-lighter) 0%, var(--rz-primary-lighter) 100%);height:100%;">
                                    <RadzenStack Gap="1rem">
                                        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                                            <RadzenIcon Icon="help" Style="font-size:1.5rem;color:var(--rz-primary);" />
                                            <RadzenText TextStyle="TextStyle.H6" Style="margin:0;">Getting an API Key</RadzenText>
                                        </RadzenStack>

                                        <RadzenStack Gap="0.75rem">
                                            <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" AlignItems="AlignItems.Start">
                                                <RadzenBadge Text="1" BadgeStyle="BadgeStyle.Primary" Style="min-width:24px;" />
                                                <RadzenText TextStyle="TextStyle.Body2">Go to platform.openai.com</RadzenText>
                                            </RadzenStack>
                                            <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" AlignItems="AlignItems.Start">
                                                <RadzenBadge Text="2" BadgeStyle="BadgeStyle.Primary" Style="min-width:24px;" />
                                                <RadzenText TextStyle="TextStyle.Body2">Sign in or create an account</RadzenText>
                                            </RadzenStack>
                                            <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" AlignItems="AlignItems.Start">
                                                <RadzenBadge Text="3" BadgeStyle="BadgeStyle.Primary" Style="min-width:24px;" />
                                                <RadzenText TextStyle="TextStyle.Body2">Navigate to API Keys section</RadzenText>
                                            </RadzenStack>
                                            <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" AlignItems="AlignItems.Start">
                                                <RadzenBadge Text="4" BadgeStyle="BadgeStyle.Primary" Style="min-width:24px;" />
                                                <RadzenText TextStyle="TextStyle.Body2">Create a new secret key</RadzenText>
                                            </RadzenStack>
                                        </RadzenStack>
                                    </RadzenStack>
                                </RadzenCard>
                            </RadzenColumn>
                        </RadzenRow>
                    </RadzenTabsItem>

                    <!-- Email Tab -->
                    <RadzenTabsItem Text="Email (SMTP)" Icon="email">
                        <RadzenRow Style="row-gap:1rem;margin-top:1rem;">
                            <RadzenColumn Size="12" SizeLG="8">
                                <RadzenCard Style="background:var(--rz-base-100);">
                                    <RadzenStack Gap="0.75rem">
                                        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                                            <RadzenIcon Icon="email" Style="color:var(--rz-success);" />
                                            <RadzenText TextStyle="TextStyle.H6" Style="margin:0;">SMTP Configuration</RadzenText>
                                        </RadzenStack>

                                        <RadzenAlert AlertStyle="AlertStyle.Info" Icon="info" Shade="Shade.Lighter" AllowClose="false">
                                            <RadzenText TextStyle="TextStyle.Body2">
                                                Configure SMTP settings to send welcome emails and notifications to students and teachers.
                                            </RadzenText>
                                        </RadzenAlert>

                                        <RadzenRow Style="row-gap:0.75rem;">
                                            <RadzenColumn Size="12" SizeMD="8">
                                                <RadzenFormField Text="SMTP Server" Variant="Variant.Outlined" Style="width:100%;">
                                                    <RadzenTextBox @bind-Value="model.EmailServer" Name="EmailServer" 
                                                                  Placeholder="e.g. smtp.gmail.com" Style="width:100%;" />
                                                    <RadzenRequiredValidator Component="EmailServer" Text="Server is required" />
                                                </RadzenFormField>
                                            </RadzenColumn>
                                            <RadzenColumn Size="12" SizeMD="4">
                                                <RadzenFormField Text="Port" Variant="Variant.Outlined" Style="width:100%;">
                                                    <RadzenNumeric @bind-Value="model.EmailPort" Name="EmailPort" 
                                                                  Min="1" Max="65535" Style="width:100%;" />
                                                    <RadzenRequiredValidator Component="EmailPort" Text="Port is required" />
                                                </RadzenFormField>
                                            </RadzenColumn>
                                            <RadzenColumn Size="12" SizeMD="6">
                                                <RadzenFormField Text="Email / Username" Variant="Variant.Outlined" Style="width:100%;">
                                                    <RadzenTextBox @bind-Value="model.EmailUsername" Name="EmailUsername" 
                                                                  Placeholder="e.g. noreply@school.edu" Style="width:100%;" />
                                                </RadzenFormField>
                                            </RadzenColumn>
                                            <RadzenColumn Size="12" SizeMD="6">
                                                <RadzenFormField Text="Password / App Password" Variant="Variant.Outlined" Style="width:100%;">
                                                    <RadzenPassword @bind-Value="model.EmailPassword" Name="EmailPassword" 
                                                                   Placeholder="Enter SMTP password" Style="width:100%;" />
                                                </RadzenFormField>
                                            </RadzenColumn>
                                        </RadzenRow>

                                        <RadzenStack Orientation="Orientation.Horizontal" Gap="0.75rem" AlignItems="AlignItems.Center">
                                            <RadzenButton Text="Send Test Email" Icon="send" ButtonStyle="ButtonStyle.Success" 
                                                         Size="ButtonSize.Medium" Click="@TestSmtp" 
                                                         Disabled="@DisableSmtpTest" IsBusy="@isTestingSmtp" />
                                            @if (smtpTestStatus != null)
                                            {
                                                <RadzenBadge Text="@smtpTestStatus" BadgeStyle="@smtpTestStyle" />
                                            }
                                        </RadzenStack>
                                    </RadzenStack>
                                </RadzenCard>
                            </RadzenColumn>

                            <RadzenColumn Size="12" SizeLG="4">
                                <RadzenCard Style="background:linear-gradient(135deg, var(--rz-success-lighter) 0%, var(--rz-info-lighter) 100%);height:100%;">
                                    <RadzenStack Gap="1rem">
                                        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                                            <RadzenIcon Icon="tips_and_updates" Style="font-size:1.5rem;color:var(--rz-success);" />
                                            <RadzenText TextStyle="TextStyle.H6" Style="margin:0;">Common SMTP Settings</RadzenText>
                                        </RadzenStack>

                                        <RadzenStack Gap="0.5rem">
                                            <RadzenCard Style="background:rgba(255,255,255,0.7);padding:0.75rem;">
                                                <RadzenText TextStyle="TextStyle.Subtitle2" Style="margin:0;">Gmail</RadzenText>
                                                <RadzenText TextStyle="TextStyle.Caption" class="text-muted">smtp.gmail.com : 587</RadzenText>
                                            </RadzenCard>
                                            <RadzenCard Style="background:rgba(255,255,255,0.7);padding:0.75rem;">
                                                <RadzenText TextStyle="TextStyle.Subtitle2" Style="margin:0;">Outlook / Office 365</RadzenText>
                                                <RadzenText TextStyle="TextStyle.Caption" class="text-muted">smtp.office365.com : 587</RadzenText>
                                            </RadzenCard>
                                            <RadzenCard Style="background:rgba(255,255,255,0.7);padding:0.75rem;">
                                                <RadzenText TextStyle="TextStyle.Subtitle2" Style="margin:0;">Yahoo</RadzenText>
                                                <RadzenText TextStyle="TextStyle.Caption" class="text-muted">smtp.mail.yahoo.com : 587</RadzenText>
                                            </RadzenCard>
                                        </RadzenStack>

                                        <RadzenAlert AlertStyle="AlertStyle.Warning" Icon="warning" Shade="Shade.Lighter" AllowClose="false">
                                            <RadzenText TextStyle="TextStyle.Caption">
                                                For Gmail, use an App Password instead of your regular password.
                                            </RadzenText>
                                        </RadzenAlert>
                                    </RadzenStack>
                                </RadzenCard>
                            </RadzenColumn>
                        </RadzenRow>
                    </RadzenTabsItem>
                </Tabs>
            </RadzenTabs>

            <!-- Action Buttons -->
            <RadzenCard Style="background:var(--rz-base-200);padding:1rem;margin-top:1rem;">
                <RadzenStack Orientation="Orientation.Horizontal" Gap="0.75rem" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center">
                    <RadzenButton Text="Reset to Defaults" Icon="restore" ButtonStyle="ButtonStyle.Light" Size="ButtonSize.Medium" 
                                 Click="@ResetDefaults" Disabled="@isSaving" />
                    <RadzenButton Text="Save All Settings" Icon="save" ButtonStyle="ButtonStyle.Primary" Size="ButtonSize.Medium" 
                                 ButtonType="ButtonType.Submit" Disabled="@isSaving" IsBusy="@isSaving" />
                </RadzenStack>
            </RadzenCard>
        </RadzenTemplateForm>
    </RadzenCard>
</RadzenStack>

@code {
    private SettingsModel model = new();
    private bool isSaving;
    private bool isTestingOpenAi;
    private bool isTestingSmtp;
    private string? openAiTestStatus;
    private BadgeStyle openAiTestStyle = BadgeStyle.Info;
    private string? smtpTestStatus;
    private BadgeStyle smtpTestStyle = BadgeStyle.Info;

    private bool DisableOpenAiTest => isTestingOpenAi || string.IsNullOrWhiteSpace(model.OpenAIApiKey);
    private bool DisableSmtpTest => isTestingSmtp || !CanTestSmtp();

    protected override async Task OnInitializedAsync()
    {
        await LoadAsync();
    }

    private async Task LoadAsync()
    {
        var all = await Context.PlatformSettings.AsNoTracking().ToListAsync();
        model.PlatformName = Get(all, "PlatformName", model.PlatformName);
        model.Version = Get(all, "Version", model.Version);
        model.CompanyName = Get(all, "Company", model.CompanyName);
        model.Copyright = Get(all, "Copyright", model.Copyright);
        model.OpenAIApiKey = Get(all, "OpenAIApiKey", "");
        model.EmailServer = Get(all, "EmailServer", "");
        model.EmailPort = int.TryParse(Get(all, "EmailPort", "587"), out var port) ? port : 587;
        model.EmailUsername = Get(all, "EmailUsername", "");
        model.EmailPassword = Get(all, "EmailPassword", "");
        model.DefaultExamDurationMinutes = int.TryParse(Get(all, "DefaultExamDurationMinutes", "120"), out var dur) ? dur : 120;
    }

    private string Get(List<PlatformSetting> list, string key, string fallback) => list.FirstOrDefault(s => s.Key == key)?.Value ?? fallback;

    private async Task OnSave()
    {
        isSaving = true;
        openAiTestStatus = null; smtpTestStatus = null;
        try
        {
            var dict = new Dictionary<string, string>
            {
                ["PlatformName"] = model.PlatformName,
                ["Version"] = model.Version,
                ["Company"] = model.CompanyName,
                ["Copyright"] = model.Copyright,
                ["OpenAIApiKey"] = model.OpenAIApiKey,
                ["EmailServer"] = model.EmailServer,
                ["EmailPort"] = model.EmailPort.ToString(),
                ["EmailUsername"] = model.EmailUsername,
                ["EmailPassword"] = model.EmailPassword,
                ["DefaultExamDurationMinutes"] = model.DefaultExamDurationMinutes.ToString()
            };
            foreach (var kv in dict)
            {
                var setting = await Context.PlatformSettings.FirstOrDefaultAsync(s => s.Key == kv.Key);
                if (setting == null)
                {
                    Context.PlatformSettings.Add(new PlatformSetting { Key = kv.Key, Value = kv.Value, LastModified = DateTime.UtcNow });
                }
                else
                {
                    setting.Value = kv.Value;
                    setting.LastModified = DateTime.UtcNow;
                }
            }
            await Context.SaveChangesAsync();
            NotificationService.Notify(NotificationSeverity.Success, "Success", "All settings have been saved successfully.");
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", ex.Message);
        }
        finally
        {
            isSaving = false;
        }
    }

    private async Task TestOpenAI()
    {
        if (string.IsNullOrWhiteSpace(model.OpenAIApiKey)) return;
        isTestingOpenAi = true;
        openAiTestStatus = null;
        openAiTestStyle = BadgeStyle.Info;
        try
        {
            using var http = new HttpClient();
            http.DefaultRequestHeaders.Add("Authorization", $"Bearer {model.OpenAIApiKey}");
            http.Timeout = TimeSpan.FromSeconds(10);
            var resp = await http.GetAsync("https://api.openai.com/v1/models");
            if (resp.IsSuccessStatusCode)
            {
                openAiTestStatus = "Connected";
                openAiTestStyle = BadgeStyle.Success;
                NotificationService.Notify(NotificationSeverity.Success, "OpenAI", "Connection successful! API key is valid.");
            }
            else
            {
                openAiTestStatus = "Failed";
                openAiTestStyle = BadgeStyle.Danger;
                NotificationService.Notify(NotificationSeverity.Error, "OpenAI", $"Connection failed with status: {(int)resp.StatusCode}");
            }
        }
        catch (Exception ex)
        {
            openAiTestStatus = "Error";
            openAiTestStyle = BadgeStyle.Danger;
            NotificationService.Notify(NotificationSeverity.Error, "OpenAI", ex.Message);
        }
        finally
        {
            isTestingOpenAi = false;
        }
    }

    private bool CanTestSmtp() => !string.IsNullOrWhiteSpace(model.EmailServer) && model.EmailPort > 0 && 
                                   !string.IsNullOrWhiteSpace(model.EmailUsername) && !string.IsNullOrWhiteSpace(model.EmailPassword);

    private async Task TestSmtp()
    {
        if (!CanTestSmtp()) return;
        isTestingSmtp = true;
        smtpTestStatus = null;
        smtpTestStyle = BadgeStyle.Info;
        try
        {
            using var client = new System.Net.Mail.SmtpClient(model.EmailServer, model.EmailPort)
            {
                EnableSsl = true,
                Credentials = new System.Net.NetworkCredential(model.EmailUsername, model.EmailPassword)
            };
            var mail = new System.Net.Mail.MailMessage(model.EmailUsername, model.EmailUsername, "PeP SMTP Test", "This is a test email from PeP settings page. If you received this, your SMTP configuration is correct!");
            await client.SendMailAsync(mail);
            smtpTestStatus = "Sent";
            smtpTestStyle = BadgeStyle.Success;
            NotificationService.Notify(NotificationSeverity.Success, "SMTP", "Test email sent successfully! Check your inbox.");
        }
        catch (Exception ex)
        {
            smtpTestStatus = "Failed";
            smtpTestStyle = BadgeStyle.Danger;
            NotificationService.Notify(NotificationSeverity.Error, "SMTP", ex.Message);
        }
        finally
        {
            isTestingSmtp = false;
        }
    }

    private async Task ResetDefaults()
    {
        var confirm = await DialogService.Confirm("Are you sure you want to reset all settings to their default values?", "Confirm Reset", 
            new ConfirmOptions { OkButtonText = "Yes, Reset", CancelButtonText = "Cancel" });
        if (confirm == true)
        {
            model = new SettingsModel();
            openAiTestStatus = null; 
            smtpTestStatus = null;
            NotificationService.Notify(NotificationSeverity.Info, "Reset Complete", "All settings have been reset to defaults. Click 'Save All Settings' to apply.");
        }
    }

    private class SettingsModel
    {
        public string PlatformName { get; set; } = "PeP - Programming Examination Platform";
        public string Version { get; set; } = "5.0";
        public string CompanyName { get; set; } = "Infinity Atom";
        public string Copyright { get; set; } = "Copyright 2021 - 2025";
        public string OpenAIApiKey { get; set; } = string.Empty;
        public string EmailServer { get; set; } = string.Empty;
        public int EmailPort { get; set; } = 587;
        public string EmailUsername { get; set; } = string.Empty;
        public string EmailPassword { get; set; } = string.Empty;
        public int DefaultExamDurationMinutes { get; set; } = 120;
    }
}
