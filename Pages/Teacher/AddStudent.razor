@page "/teacher/add-student"
@attribute [Authorize(Roles = UserRoles.Teacher)]
@inject IUserService UserService
@inject NotificationService NotificationService
@inject NavigationManager Navigation

<PageTitle>Add Student - PeP v5.0</PageTitle>

<RadzenStack Gap="0.75rem" Style="max-width:1400px;margin:0 auto;">
    <RadzenBreadCrumb>
        <RadzenBreadCrumbItem Path="/" Text="Home" Icon="home" />
        <RadzenBreadCrumbItem Path="/teacher/students" Text="Students" Icon="people" />
        <RadzenBreadCrumbItem Text="Add Student" Icon="person_add" />
    </RadzenBreadCrumb>

    <RadzenCard Style="padding:1.25rem;">
        <RadzenStack Gap="0.5rem" Style="margin-bottom:1rem;">
            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween">
                <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                    <RadzenIcon Icon="person_add" Style="font-size:2rem;color:var(--rz-primary);" />
                    <RadzenText TextStyle="TextStyle.H4" TagName="TagName.H1" Style="margin:0;">Add New Student</RadzenText>
                </RadzenStack>
                <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem">
                    <RadzenButton Text="CSV Import" Icon="upload_file" ButtonStyle="ButtonStyle.Info" Size="ButtonSize.Medium" 
                                 Click="@(() => Navigation.NavigateTo("/teacher/import-students"))" />
                    <RadzenButton Text="Back to Students" Icon="arrow_back" ButtonStyle="ButtonStyle.Light" Size="ButtonSize.Medium" 
                                 Click="@(() => Navigation.NavigateTo("/teacher/students"))" />
                </RadzenStack>
            </RadzenStack>
            <RadzenText TextStyle="TextStyle.Body2" class="text-muted">Create a new student account. Fill in the required information below.</RadzenText>
        </RadzenStack>

        <RadzenTemplateForm Data="@studentModel" TItem="RegisterViewModel" Submit="@CreateStudent">
            <RadzenRow Style="row-gap:1rem;">
                <!-- Left Column - Form Fields -->
                <RadzenColumn Size="12" SizeLG="8">
                    <RadzenStack Gap="1rem">
                        <!-- Personal Information Card -->
                        <RadzenCard Style="background:var(--rz-base-100);">
                            <RadzenStack Gap="0.75rem">
                                <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                                    <RadzenIcon Icon="person" Style="color:var(--rz-info);" />
                                    <RadzenText TextStyle="TextStyle.H6" Style="margin:0;">Personal Information</RadzenText>
                                </RadzenStack>

                                <RadzenRow Style="row-gap:0.75rem;">
                                    <RadzenColumn Size="12" SizeMD="6">
                                        <RadzenFormField Text="First Name" Variant="Variant.Outlined" Style="width:100%;">
                                            <RadzenTextBox @bind-Value="studentModel.FirstName" Name="FirstName" MaxLength="50" 
                                                          Placeholder="e.g. John" Style="width:100%;" />
                                            <RadzenRequiredValidator Component="FirstName" Text="First name is required" />
                                        </RadzenFormField>
                                    </RadzenColumn>
                                    <RadzenColumn Size="12" SizeMD="6">
                                        <RadzenFormField Text="Last Name" Variant="Variant.Outlined" Style="width:100%;">
                                            <RadzenTextBox @bind-Value="studentModel.LastName" Name="LastName" MaxLength="50" 
                                                          Placeholder="e.g. Doe" Style="width:100%;" />
                                            <RadzenRequiredValidator Component="LastName" Text="Last name is required" />
                                        </RadzenFormField>
                                    </RadzenColumn>
                                    <RadzenColumn Size="12" SizeMD="6">
                                        <RadzenFormField Text="Email Address" Variant="Variant.Outlined" Style="width:100%;">
                                            <RadzenTextBox @bind-Value="studentModel.Email" Name="Email" MaxLength="255" 
                                                          Placeholder="e.g. student@school.edu" Style="width:100%;" />
                                            <RadzenRequiredValidator Component="Email" Text="Email is required" />
                                            <RadzenEmailValidator Component="Email" Text="Please enter a valid email address" />
                                        </RadzenFormField>
                                    </RadzenColumn>
                                    <RadzenColumn Size="12" SizeMD="6">
                                        <RadzenFormField Text="Student ID (Optional)" Variant="Variant.Outlined" Style="width:100%;">
                                            <RadzenTextBox @bind-Value="studentModel.StudentId" Name="StudentId" MaxLength="50" 
                                                          Placeholder="e.g. STU-2025-001" Style="width:100%;" />
                                        </RadzenFormField>
                                    </RadzenColumn>
                                </RadzenRow>
                            </RadzenStack>
                        </RadzenCard>

                        <!-- Security Card -->
                        <RadzenCard Style="background:var(--rz-base-100);">
                            <RadzenStack Gap="0.75rem">
                                <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                                    <RadzenIcon Icon="security" Style="color:var(--rz-warning);" />
                                    <RadzenText TextStyle="TextStyle.H6" Style="margin:0;">Account Security</RadzenText>
                                </RadzenStack>

                                <RadzenRow Style="row-gap:0.75rem;">
                                    <RadzenColumn Size="12" SizeMD="6">
                                        <RadzenFormField Text="Password" Variant="Variant.Outlined" Style="width:100%;">
                                            <ChildContent>
                                                <RadzenPassword @bind-Value="studentModel.Password" Name="Password" 
                                                               Placeholder="Enter a strong password" Style="width:100%;" />
                                            </ChildContent>
                                            <End>
                                                <RadzenButton Icon="autorenew" ButtonStyle="ButtonStyle.Secondary" Variant="Variant.Text"
                                                             Size="ButtonSize.Small" Title="Generate Random Password" 
                                                             Click="@GeneratePassword" Style="margin-right:8px;" />
                                            </End>
                                        </RadzenFormField>
                                        <RadzenRequiredValidator Component="Password" Text="Password is required" />
                                        <RadzenLengthValidator Component="Password" Min="6" Text="Password must be at least 6 characters" />
                                    </RadzenColumn>
                                    <RadzenColumn Size="12" SizeMD="6">
                                        <RadzenFormField Text="Confirm Password" Variant="Variant.Outlined" Style="width:100%;">
                                            <RadzenPassword @bind-Value="studentModel.ConfirmPassword" Name="ConfirmPassword" 
                                                           Placeholder="Repeat the password" Style="width:100%;" />
                                            <RadzenRequiredValidator Component="ConfirmPassword" Text="Please confirm the password" />
                                            <RadzenCompareValidator Component="ConfirmPassword" Value="@studentModel.Password" Text="Passwords do not match" />
                                        </RadzenFormField>
                                    </RadzenColumn>
                                </RadzenRow>

                                @if (!string.IsNullOrEmpty(studentModel.Password))
                                {
                                    <RadzenAlert AlertStyle="AlertStyle.Info" Icon="info" Shade="Shade.Lighter" AllowClose="false" Style="margin-top:0.5rem;">
                                        <RadzenText TextStyle="TextStyle.Body2">
                                            <strong>Generated Password:</strong> @studentModel.Password
                                        </RadzenText>
                                    </RadzenAlert>
                                }
                            </RadzenStack>
                        </RadzenCard>

                        <!-- Notification Settings Card -->
                        <RadzenCard Style="background:var(--rz-base-100);">
                            <RadzenStack Gap="0.75rem">
                                <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                                    <RadzenIcon Icon="email" Style="color:var(--rz-success);" />
                                    <RadzenText TextStyle="TextStyle.H6" Style="margin:0;">Notification Settings</RadzenText>
                                </RadzenStack>

                                <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                                    <RadzenCheckBox @bind-Value="sendWelcomeEmail" Name="WelcomeEmail" TValue="bool" />
                                    <RadzenLabel Component="WelcomeEmail" Text="Send welcome email with login credentials" Style="cursor:pointer;" />
                                    @if (sendWelcomeEmail)
                                    {
                                        <RadzenBadge Text="Recommended" BadgeStyle="BadgeStyle.Success" Shade="Shade.Lighter" />
                                    }
                                </RadzenStack>
                            </RadzenStack>
                        </RadzenCard>
                    </RadzenStack>
                </RadzenColumn>

                <!-- Right Column - Guidelines -->
                <RadzenColumn Size="12" SizeLG="4">
                    <RadzenCard Style="background:linear-gradient(135deg, var(--rz-info-lighter) 0%, var(--rz-primary-lighter) 100%);height:100%;">
                        <RadzenStack Gap="1rem">
                            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                                <RadzenIcon Icon="tips_and_updates" Style="font-size:1.5rem;color:var(--rz-primary);" />
                                <RadzenText TextStyle="TextStyle.H6" Style="margin:0;">Tips & Guidelines</RadzenText>
                            </RadzenStack>

                            <RadzenStack Gap="0.75rem">
                                @foreach (var tip in tips)
                                {
                                    <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" AlignItems="AlignItems.Start">
                                        <RadzenIcon Icon="check_circle" Style="color:var(--rz-success);font-size:1.1rem;margin-top:2px;" />
                                        <RadzenText TextStyle="TextStyle.Body2">@tip</RadzenText>
                                    </RadzenStack>
                                }
                            </RadzenStack>

                            <RadzenCard Style="background:rgba(255,255,255,0.7);margin-top:0.5rem;">
                                <RadzenStack Gap="0.5rem">
                                    <RadzenText TextStyle="TextStyle.Subtitle2" Style="margin:0;">
                                        <RadzenIcon Icon="groups" Style="margin-right:4px;" /> Need to add many students?
                                    </RadzenText>
                                    <RadzenText TextStyle="TextStyle.Caption" class="text-muted">
                                        Use the CSV import feature to add multiple students at once from an Excel or CSV file.
                                    </RadzenText>
                                    <RadzenButton Text="Open CSV Import" Icon="upload_file" ButtonStyle="ButtonStyle.Info" 
                                                 Size="ButtonSize.Small" Style="width:100%;"
                                                 Click="@(() => Navigation.NavigateTo("/teacher/import-students"))" />
                                </RadzenStack>
                            </RadzenCard>
                        </RadzenStack>
                    </RadzenCard>
                </RadzenColumn>
            </RadzenRow>

            <!-- Action Buttons -->
            <RadzenCard Style="background:var(--rz-base-200);padding:1rem;margin-top:1rem;">
                <RadzenStack Orientation="Orientation.Horizontal" Gap="0.75rem" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center">
                    <RadzenButton Text="Cancel" Icon="close" ButtonStyle="ButtonStyle.Light" Size="ButtonSize.Medium" 
                                 Click="@(() => Navigation.NavigateTo("/teacher/students"))" Disabled="@isCreating" />
                    <RadzenStack Orientation="Orientation.Horizontal" Gap="0.75rem">
                        <RadzenButton Text="Reset Form" Icon="refresh" ButtonStyle="ButtonStyle.Secondary" Size="ButtonSize.Medium" 
                                     Click="@ResetForm" Disabled="@isCreating" />
                        <RadzenButton Text="Create Student" Icon="person_add" ButtonStyle="ButtonStyle.Primary" Size="ButtonSize.Medium" 
                                     ButtonType="ButtonType.Submit" IsBusy="@isCreating" Disabled="@isCreating" />
                    </RadzenStack>
                </RadzenStack>
            </RadzenCard>
        </RadzenTemplateForm>
    </RadzenCard>
</RadzenStack>

@code {
    private RegisterViewModel studentModel = new() { Role = UserRoles.Student };
    private bool isCreating;
    private bool sendWelcomeEmail = true;
    
    private readonly List<string> tips = new()
    {
        "Email addresses must be unique across all accounts.",
        "Passwords should be at least 6 characters long.",
        "Include numbers and mixed case for stronger passwords.",
        "Student ID is optional but useful for external system integration.",
        "Welcome email includes login credentials if enabled."
    };

    private async Task CreateStudent()
    {
        if (isCreating) return;
        isCreating = true;
        try
        {
            var user = await UserService.CreateStudentAsync(studentModel);
            if (user != null)
            {
                if (sendWelcomeEmail)
                {
                    await UserService.SendWelcomeEmailAsync(user, studentModel.Password);
                }
                NotificationService.Notify(NotificationSeverity.Success, "Success", $"Student account for {studentModel.FirstName} {studentModel.LastName} created successfully.");
                ResetForm();
            }
            else
            {
                NotificationService.Notify(NotificationSeverity.Error, "Failed", "Could not create student account. Please try again.");
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", ex.Message);
        }
        finally
        {
            isCreating = false;
        }
    }

    private void ResetForm()
    {
        studentModel = new RegisterViewModel { Role = UserRoles.Student };
        sendWelcomeEmail = true;
    }

    private void GeneratePassword()
    {
        var rnd = new Random();
        const string chars = "ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnpqrstuvwxyz23456789!@#$";
        studentModel.Password = new string(Enumerable.Range(0, 12).Select(_ => chars[rnd.Next(chars.Length)]).ToArray());
        studentModel.ConfirmPassword = studentModel.Password;
        NotificationService.Notify(NotificationSeverity.Info, "Password Generated", "A random secure password has been generated.");
    }
}
