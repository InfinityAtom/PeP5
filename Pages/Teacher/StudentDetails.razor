@page "/teacher/student/{Id}"
@attribute [Authorize(Roles = UserRoles.Teacher)]
@inject UserManager<ApplicationUser> UserManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IExamService ExamService
@inject NavigationManager Navigation

<PageTitle>Student Profile - PeP v5.0</PageTitle>

<RadzenStack Gap="1rem">
    <RadzenBreadCrumb>
        <RadzenBreadCrumbItem Path="/" Text="Home" />
        <RadzenBreadCrumbItem Path="/teacher/students" Text="Manage Students" />
        <RadzenBreadCrumbItem Text="Student Profile" />
    </RadzenBreadCrumb>

    @if (isLoading)
    {
        <RadzenCard>
            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="1rem">
                <RadzenProgressBarCircular ShowValue="false" Size="ProgressBarCircularSize.Medium" />
                <RadzenText>Loading student details...</RadzenText>
            </RadzenStack>
        </RadzenCard>
    }
    else if (!string.IsNullOrEmpty(loadError))
    {
        <RadzenAlert AlertStyle="AlertStyle.Danger" Icon="error">
            @loadError
        </RadzenAlert>
        <RadzenButton Text="Back to Students" Icon="arrow_back" ButtonStyle="ButtonStyle.Primary" Click="@(() => Navigation.NavigateTo("/teacher/students"))" />
    }
    else if (student != null)
    {
        <RadzenStack Gap="1rem">
            <RadzenCard>
                <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center">
                    <RadzenStack Gap="0.35rem">
                        <RadzenText TextStyle="TextStyle.H4" TagName="TagName.H1" Style="margin:0;">@student.FullName</RadzenText>
                        <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" AlignItems="AlignItems.Center">
                            <RadzenBadge Text="@student.Email" BadgeStyle="BadgeStyle.Info" />
                            <RadzenBadge Text="@($"Student ID: {student.StudentId ?? "N/A"}")" BadgeStyle="BadgeStyle.Light" />
                        </RadzenStack>
                    </RadzenStack>
                    <RadzenStack Gap="0.25rem" AlignItems="AlignItems.End">
                        <RadzenBadge Text="@($"Status: {(student.IsActive ? "Active" : "Inactive")}")" BadgeStyle="@(student.IsActive ? BadgeStyle.Success : BadgeStyle.Danger)" />
                        <RadzenText TextStyle="TextStyle.Caption" class="text-muted">
                            Joined @student.CreatedAt.ToLocalTime().ToString("MM/dd/yyyy")
                        </RadzenText>
                    </RadzenStack>
                </RadzenStack>
            </RadzenCard>

            <RadzenRow Gutter="16px">
                <RadzenColumn Size="12" SizeMD="4">
                    <RadzenCard>
                        <RadzenStack Gap="0.25rem" class="text-center">
                            <RadzenText TextStyle="TextStyle.Caption" class="text-muted">Attempts</RadzenText>
                            <RadzenText TextStyle="TextStyle.H5">@attempts.Count</RadzenText>
                        </RadzenStack>
                    </RadzenCard>
                </RadzenColumn>
                <RadzenColumn Size="12" SizeMD="4">
                    <RadzenCard>
                        <RadzenStack Gap="0.25rem" class="text-center">
                            <RadzenText TextStyle="TextStyle.Caption" class="text-muted">Completed</RadzenText>
                            <RadzenText TextStyle="TextStyle.H5">@completedAttempts</RadzenText>
                        </RadzenStack>
                    </RadzenCard>
                </RadzenColumn>
                <RadzenColumn Size="12" SizeMD="4">
                    <RadzenCard>
                        <RadzenStack Gap="0.25rem" class="text-center">
                            <RadzenText TextStyle="TextStyle.Caption" class="text-muted">Average Score</RadzenText>
                            <RadzenText TextStyle="TextStyle.H5">@($"{averageScore:F1}%")</RadzenText>
                        </RadzenStack>
                    </RadzenCard>
                </RadzenColumn>
            </RadzenRow>

            <RadzenCard>
                <RadzenStack Gap="0.75rem">
                    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween">
                        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                            <RadzenIcon Icon="assignment" Style="color:var(--rz-primary);" />
                            <RadzenText TextStyle="TextStyle.H5" TagName="TagName.H2" Style="margin:0;">Exam Attempts</RadzenText>
                        </RadzenStack>
                        <RadzenButton Text="Back to Students" Icon="arrow_back" ButtonStyle="ButtonStyle.Light" Click="@(() => Navigation.NavigateTo("/teacher/students"))" />
                    </RadzenStack>

                    @if (attempts.Any())
                    {
                        <RadzenDataGrid Data="@attempts" TItem="ExamAttempt" AllowPaging="true" PageSize="10"
                                        AllowSorting="true" AllowFiltering="true" LogicalFilterOperator="LogicalFilterOperator.Or">
                            <Columns>
                                <RadzenDataGridColumn TItem="ExamAttempt" Property="Exam.Title" Title="Exam" Width="220px" />
                                <RadzenDataGridColumn TItem="ExamAttempt" Property="Exam.Course.Name" Title="Course" Width="160px">
                                    <Template Context="data">
                                        @data.Exam.Course?.Name
                                    </Template>
                                </RadzenDataGridColumn>
                                <RadzenDataGridColumn TItem="ExamAttempt" Property="Status" Title="Status" Width="120px">
                                    <Template Context="data">
                                        <RadzenBadge Text="@data.Status.ToString()" BadgeStyle="GetStatusBadge(data.Status)" />
                                    </Template>
                                </RadzenDataGridColumn>
                                <RadzenDataGridColumn TItem="ExamAttempt" Title="Score" Width="120px">
                                    <Template Context="data">
                                        @($"{data.TotalScore:F1}")
                                    </Template>
                                </RadzenDataGridColumn>
                                <RadzenDataGridColumn TItem="ExamAttempt" Property="StartedAt" Title="Started" Width="160px">
                                    <Template Context="data">
                                        @data.StartedAt.ToLocalTime().ToString("MM/dd/yyyy HH:mm")
                                    </Template>
                                </RadzenDataGridColumn>
                                <RadzenDataGridColumn TItem="ExamAttempt" Property="SubmittedAt" Title="Submitted" Width="160px">
                                    <Template Context="data">
                                        @data.SubmittedAt?.ToLocalTime().ToString("MM/dd/yyyy HH:mm")
                                    </Template>
                                </RadzenDataGridColumn>
                            </Columns>
                        </RadzenDataGrid>
                    }
                    else
                    {
                        <RadzenAlert AlertStyle="AlertStyle.Info" Icon="info">
                            This student has not taken any of your exams yet.
                        </RadzenAlert>
                    }
                </RadzenStack>
            </RadzenCard>
        </RadzenStack>
    }
</RadzenStack>

@code {
    [Parameter] public string Id { get; set; } = string.Empty;

    private ApplicationUser? student;
    private List<ExamAttempt> attempts = new();
    private bool isLoading = true;
    private string? loadError;
    private int completedAttempts;
    private decimal averageScore;

    protected override async Task OnParametersSetAsync()
    {
        await LoadStudentAsync();
    }

    private async Task LoadStudentAsync()
    {
        isLoading = true;
        loadError = null;
        attempts.Clear();
        completedAttempts = 0;
        averageScore = 0;

        try
        {
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            if (authState?.User?.Identity?.IsAuthenticated == true)
            {
                var teacherId = UserManager.GetUserId(authState.User);
                if (string.IsNullOrEmpty(teacherId))
                {
                    loadError = "Unable to determine your teacher account.";
                    return;
                }

                student = await UserManager.FindByIdAsync(Id);
                if (student == null || !await UserManager.IsInRoleAsync(student, UserRoles.Student))
                {
                    loadError = "Student not found.";
                    return;
                }

                var allAttempts = await ExamService.GetAllExamAttemptsForTeacherAsync(teacherId);
                attempts = allAttempts
                    .Where(a => a.StudentId == student.Id)
                    .OrderByDescending(a => a.StartedAt)
                    .ToList();

                completedAttempts = attempts.Count(a => a.Status == ExamAttemptStatus.Completed);
                if (attempts.Any())
                {
                    averageScore = attempts.Average(a => a.TotalScore);
                }
            }
        }
        catch (Exception ex)
        {
            loadError = "An error occurred while loading this student.";
            Console.WriteLine($"Student load error: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private BadgeStyle GetStatusBadge(ExamAttemptStatus status)
    {
        return status switch
        {
            ExamAttemptStatus.Completed => BadgeStyle.Success,
            ExamAttemptStatus.InProgress => BadgeStyle.Info,
            ExamAttemptStatus.Abandoned => BadgeStyle.Warning,
            ExamAttemptStatus.TimeExpired => BadgeStyle.Danger,
            _ => BadgeStyle.Secondary
        };
    }
}
