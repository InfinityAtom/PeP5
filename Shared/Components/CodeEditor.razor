@using PeP.Models

<div class="code-editor-container" style="height: 100%; display: flex; flex-direction: column;">
    @if (!string.IsNullOrEmpty(FileName))
    {
        <div class="editor-header" style="padding: 0.5rem 1rem; background: var(--rz-base-200); border-bottom: 1px solid var(--rz-base-400); display: flex; justify-content: space-between; align-items: center;">
            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                <RadzenIcon Icon="@GetFileIcon()" Style="color: var(--rz-info);" />
                <RadzenText TextStyle="TextStyle.Body2" Style="margin: 0; font-weight: 500;">@FileName</RadzenText>
                @if (IsModified)
                {
                    <RadzenBadge BadgeStyle="BadgeStyle.Warning" IsPill="true" Text="Modified" />
                }
                @if (IsReadOnly)
                {
                    <RadzenBadge BadgeStyle="BadgeStyle.Light" IsPill="true" Text="Read Only" />
                }
            </RadzenStack>
            <RadzenStack Orientation="Orientation.Horizontal" Gap="0.25rem">
                <RadzenButton Icon="save" Size="ButtonSize.ExtraSmall" ButtonStyle="ButtonStyle.Light" 
                             Click="@OnSaveClick" Disabled="@(!IsModified || IsReadOnly)"
                             title="Save (Ctrl+S)" />
                <RadzenButton Icon="undo" Size="ButtonSize.ExtraSmall" ButtonStyle="ButtonStyle.Light" 
                             Click="@OnUndoClick" title="Undo (Ctrl+Z)" />
                <RadzenButton Icon="redo" Size="ButtonSize.ExtraSmall" ButtonStyle="ButtonStyle.Light" 
                             Click="@OnRedoClick" title="Redo (Ctrl+Y)" />
            </RadzenStack>
        </div>
    }

    <div class="editor-wrapper" style="flex: 1; position: relative; overflow: hidden;">
        <div id="@EditorId" style="width: 100%; height: 100%; position: absolute; top: 0; left: 0;"></div>
    </div>
</div>

@code {
    [Parameter] public string EditorId { get; set; } = "monaco-editor-" + Guid.NewGuid().ToString("N");
    [Parameter] public string Content { get; set; } = string.Empty;
    [Parameter] public string FileName { get; set; } = string.Empty;
    [Parameter] public ProgrammingLanguage Language { get; set; } = ProgrammingLanguage.Java;
    [Parameter] public bool IsReadOnly { get; set; } = false;
    [Parameter] public bool IsModified { get; set; } = false;
    [Parameter] public string Theme { get; set; } = "vs-dark";
    [Parameter] public EventCallback<string> ContentChanged { get; set; }
    [Parameter] public EventCallback OnSave { get; set; }

    [Inject] private IJSRuntime JSRuntime { get; set; } = default!;

    private string _originalContent = string.Empty;
    private bool _isInitialized = false;
    private DotNetObjectReference<CodeEditor>? _dotNetRef;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _dotNetRef = DotNetObjectReference.Create(this);
            _originalContent = Content;
            await InitializeEditor();
            _isInitialized = true;
        }
    }

    protected override async Task OnParametersSetAsync()
    {
        if (_isInitialized && !string.IsNullOrEmpty(Content))
        {
            var currentContent = await GetEditorContent();
            if (currentContent != Content)
            {
                await SetEditorContent(Content);
                _originalContent = Content;
            }
        }
    }

    private async Task InitializeEditor()
    {
        var languageId = GetMonacoLanguage();
        await JSRuntime.InvokeVoidAsync("pepMonaco.createEditor", 
            EditorId, 
            Content, 
            languageId, 
            Theme, 
            IsReadOnly,
            _dotNetRef);
    }

    [JSInvokable]
    public async Task OnEditorContentChanged(string newContent)
    {
        IsModified = newContent != _originalContent;
        await ContentChanged.InvokeAsync(newContent);
        StateHasChanged();
    }

    [JSInvokable]
    public async Task OnEditorSaveRequested()
    {
        await OnSaveClick();
    }

    public async Task<string> GetEditorContent()
    {
        return await JSRuntime.InvokeAsync<string>("pepMonaco.getContent", EditorId);
    }

    public async Task SetEditorContent(string content)
    {
        await JSRuntime.InvokeVoidAsync("pepMonaco.setContent", EditorId, content);
        _originalContent = content;
        IsModified = false;
    }

    public async Task Focus()
    {
        await JSRuntime.InvokeVoidAsync("pepMonaco.focus", EditorId);
    }

    public async Task SetLanguage(ProgrammingLanguage language)
    {
        Language = language;
        await JSRuntime.InvokeVoidAsync("pepMonaco.setLanguage", EditorId, GetMonacoLanguage());
    }

    private async Task OnSaveClick()
    {
        if (!IsReadOnly)
        {
            await OnSave.InvokeAsync();
            _originalContent = await GetEditorContent();
            IsModified = false;
            StateHasChanged();
        }
    }

    private async Task OnUndoClick()
    {
        await JSRuntime.InvokeVoidAsync("pepMonaco.undo", EditorId);
    }

    private async Task OnRedoClick()
    {
        await JSRuntime.InvokeVoidAsync("pepMonaco.redo", EditorId);
    }

    private string GetMonacoLanguage()
    {
        return Language switch
        {
            ProgrammingLanguage.Java => "java",
            ProgrammingLanguage.Python => "python",
            ProgrammingLanguage.CSharp => "csharp",
            ProgrammingLanguage.CPlusPlus => "cpp",
            ProgrammingLanguage.JavaScript => "javascript",
            ProgrammingLanguage.TypeScript => "typescript",
            ProgrammingLanguage.C => "c",
            ProgrammingLanguage.SQL => "sql",
            _ => "plaintext"
        };
    }

    private string GetFileIcon()
    {
        var extension = Path.GetExtension(FileName)?.ToLowerInvariant();
        return extension switch
        {
            ".java" => "code",
            ".py" => "code",
            ".cs" => "code",
            ".cpp" or ".c" or ".h" => "code",
            ".js" => "javascript",
            ".ts" => "code",
            ".sql" => "storage",
            ".csv" => "table_chart",
            ".json" => "data_object",
            ".xml" => "code",
            ".txt" => "description",
            ".md" => "article",
            _ => "insert_drive_file"
        };
    }

    public void Dispose()
    {
        _dotNetRef?.Dispose();
    }
}
