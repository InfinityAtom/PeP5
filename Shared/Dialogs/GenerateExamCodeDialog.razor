@using Microsoft.AspNetCore.Components.Authorization
@inject IExamService ExamService
@inject UserManager<ApplicationUser> UserManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject NotificationService NotificationService

<RadzenStack Gap="1rem" Style="min-width:480px;">
    <!-- Header -->
    <RadzenStack Gap="0.25rem" Style="border-bottom:1px solid var(--rz-base-300);padding-bottom:0.75rem;">
        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
            <RadzenIcon Icon="vpn_key" Style="font-size:1.5rem;color:var(--rz-warning);" />
            <RadzenText TextStyle="TextStyle.H6" TagName="TagName.H2" Style="margin:0;">Generate Exam Code</RadzenText>
        </RadzenStack>
        <RadzenText TextStyle="TextStyle.Caption" class="text-muted">Create a shareable code for students to access an exam.</RadzenText>
    </RadzenStack>

    <RadzenTemplateForm TItem="ExamCodeViewModel" Data="@model" Submit="@OnSubmit">
        <RadzenStack Gap="1rem">
            <!-- Exam Selection Card -->
            <RadzenCard Style="background:linear-gradient(135deg, var(--rz-primary-lighter) 0%, var(--rz-base-100) 100%);padding:1rem;">
                <RadzenStack Gap="0.75rem">
                    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                        <RadzenIcon Icon="quiz" Style="color:var(--rz-primary);font-size:1.1rem;" />
                        <RadzenText TextStyle="TextStyle.Subtitle1" Style="margin:0;font-weight:500;">Select Exam</RadzenText>
                    </RadzenStack>

                    <RadzenFormField Text="Exam" Variant="Variant.Outlined" Style="width:100%;">
                        <RadzenDropDown @bind-Value="@model.ExamId" Data="@availableExams" TextProperty="Title" ValueProperty="Id" 
                                      Placeholder="Choose an exam..." Style="width:100%;" Name="ExamId" />
                        <RadzenRequiredValidator Component="ExamId" Text="Please select an exam" />
                    </RadzenFormField>

                    <RadzenFormField Text="Description (Optional)" Variant="Variant.Outlined" Style="width:100%;">
                        <RadzenTextBox @bind-Value="@model.Description" MaxLength="500" Placeholder="e.g. Section A - Morning Session" Name="Description" Style="width:100%;" />
                    </RadzenFormField>
                </RadzenStack>
            </RadzenCard>

            <!-- Settings Card -->
            <RadzenCard Style="background:var(--rz-base-100);padding:1rem;">
                <RadzenStack Gap="0.75rem">
                    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                        <RadzenIcon Icon="settings" Style="color:var(--rz-info);font-size:1.1rem;" />
                        <RadzenText TextStyle="TextStyle.Subtitle1" Style="margin:0;font-weight:500;">Code Settings</RadzenText>
                    </RadzenStack>

                    <RadzenRow Style="row-gap:0.75rem;">
                        <RadzenColumn Size="12" SizeMD="6">
                            <RadzenFormField Text="Expires At" Variant="Variant.Outlined" Style="width:100%;">
                                <RadzenDatePicker @bind-Value="@model.ExpiresAt" DateFormat="MM/dd/yyyy HH:mm" ShowTime="true" Name="ExpiresAt" Style="width:100%;" />
                                <RadzenRequiredValidator Component="ExpiresAt" Text="Expiration date is required" />
                            </RadzenFormField>
                        </RadzenColumn>
                        <RadzenColumn Size="12" SizeMD="6">
                            <RadzenFormField Text="Maximum Uses" Variant="Variant.Outlined" Style="width:100%;">
                                <ChildContent>
                                    <RadzenNumeric @bind-Value="@model.MaxUses" Min="1" Max="1000" Placeholder="Unlimited" Name="MaxUses" Style="width:100%;" />
                                </ChildContent>
                                <Helper>
                                    <RadzenText TextStyle="TextStyle.Caption" class="text-muted">Leave empty for unlimited</RadzenText>
                                </Helper>
                            </RadzenFormField>
                        </RadzenColumn>
                    </RadzenRow>
                </RadzenStack>
            </RadzenCard>

            <!-- Status Card -->
            <RadzenCard Style="background:var(--rz-base-100);padding:1rem;">
                <RadzenStack Gap="0.75rem">
                    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                        <RadzenIcon Icon="toggle_on" Style="color:var(--rz-success);font-size:1.1rem;" />
                        <RadzenText TextStyle="TextStyle.Subtitle1" Style="margin:0;font-weight:500;">Availability</RadzenText>
                    </RadzenStack>

                    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween">
                        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.75rem">
                            <RadzenSwitch @bind-Value="@model.IsActive" Name="IsActive" />
                            <RadzenText TextStyle="TextStyle.Body2">Code Active</RadzenText>
                        </RadzenStack>
                        <RadzenBadge Text="@(model.IsActive ? "Active" : "Disabled")" BadgeStyle="@(model.IsActive ? BadgeStyle.Success : BadgeStyle.Danger)" />
                    </RadzenStack>
                </RadzenStack>
            </RadzenCard>

            <!-- Action Buttons -->
            <RadzenStack Orientation="Orientation.Horizontal" Gap="0.75rem" JustifyContent="JustifyContent.End" Style="padding-top:0.5rem;border-top:1px solid var(--rz-base-300);">
                <RadzenButton Text="Cancel" Icon="close" ButtonStyle="ButtonStyle.Light" Click="@(() => dialogService.Close(false))" />
                <RadzenButton Text="Generate Code" Icon="vpn_key" ButtonStyle="ButtonStyle.Warning" ButtonType="ButtonType.Submit" IsBusy="@isSubmitting" Disabled="@isSubmitting" />
            </RadzenStack>
        </RadzenStack>
    </RadzenTemplateForm>
</RadzenStack>

@code {
    [Inject] public DialogService dialogService { get; set; } = default!;

    private ExamCodeViewModel model = new() { IsActive = true, ExpiresAt = DateTime.Now.AddDays(7) };
    private List<Exam> availableExams = new();
    private bool isSubmitting;

    protected override async Task OnInitializedAsync()
    {
        await LoadAvailableExams();
    }

    private async Task LoadAvailableExams()
    {
        try
        {
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            if (authState?.User?.Identity?.IsAuthenticated == true)
            {
                var userId = UserManager.GetUserId(authState.User);
                if (!string.IsNullOrEmpty(userId))
                {
                    availableExams = await ExamService.GetExamsForTeacherAsync(userId);
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading exams: {ex.Message}");
        }
    }

    private async Task OnSubmit()
    {
        try
        {
            isSubmitting = true;

            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            if (authState?.User?.Identity?.IsAuthenticated == true)
            {
                var userId = UserManager.GetUserId(authState.User);
                if (!string.IsNullOrEmpty(userId))
                {
                    var code = await ExamService.GenerateExamCodeAsync(
                        model.ExamId, 
                        model.ExpiresAt, 
                        model.MaxUses, 
                        userId, 
                        model.Description);

                    NotificationService.Notify(NotificationSeverity.Success, "Success", 
                        $"Exam code '{code}' generated successfully");
                    dialogService.Close(true);
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error generating exam code: {ex.Message}");
            NotificationService.Notify(NotificationSeverity.Error, "Error", "An error occurred while generating the exam code");
        }
        finally
        {
            isSubmitting = false;
        }
    }

    public class ExamCodeViewModel
    {
        public int ExamId { get; set; }
        public string Description { get; set; } = string.Empty;
        public DateTime ExpiresAt { get; set; }
        public int? MaxUses { get; set; }
        public bool IsActive { get; set; } = true;
    }
}
