@inject IExamService ExamService
@inject NotificationService NotificationService

<RadzenTemplateForm TItem="CourseViewModel" Data="@model" Submit="@OnSubmit">
    <RadzenStack Gap="1rem">
        <RadzenFormField Text="Course Code" Variant="Variant.Outlined">
            <RadzenTextBox @bind-Value="@model.Code" MaxLength="20" Placeholder="e.g. CS101" Name="Code" />
        </RadzenFormField>

        <RadzenFormField Text="Course Name" Variant="Variant.Outlined">
            <RadzenTextBox @bind-Value="@model.Name" MaxLength="200" Name="Name" />
            <RadzenRequiredValidator Component="Name" Text="Course name is required" />
        </RadzenFormField>

        <RadzenFormField Text="Description" Variant="Variant.Outlined">
            <RadzenTextArea @bind-Value="@model.Description" MaxLength="1000" Rows="4" Name="Description" />
        </RadzenFormField>

        <RadzenFormField Text="Active" Variant="Variant.Outlined">
            <RadzenSwitch @bind-Value="@model.IsActive" Name="IsActive" />
            <RadzenText TextStyle="TextStyle.Caption" class="ms-2">
                @(model.IsActive ? "Course is active" : "Course is inactive")
            </RadzenText>
        </RadzenFormField>

        <RadzenStack Orientation="Orientation.Horizontal" Gap="1rem" JustifyContent="JustifyContent.End">
            <RadzenButton Text="Cancel" ButtonStyle="ButtonStyle.Light" Click="@(() => dialogService.Close(false))" />
            <RadzenButton Text="Add Course" ButtonStyle="ButtonStyle.Primary" ButtonType="ButtonType.Submit" IsBusy="@isSubmitting" />
        </RadzenStack>
    </RadzenStack>
</RadzenTemplateForm>

@code {
    [Inject] public DialogService dialogService { get; set; } = default!;
    [Inject] public ApplicationDbContext Context { get; set; } = default!;

    private CourseViewModel model = new() { IsActive = true };
    private bool isSubmitting;

    private async Task OnSubmit()
    {
        try
        {
            isSubmitting = true;

            var course = new Course
            {
                Code = model.Code,
                Name = model.Name,
                Description = model.Description,
                IsActive = model.IsActive,
                CreatedAt = DateTime.UtcNow
            };

            Context.Courses.Add(course);
            await Context.SaveChangesAsync();

            NotificationService.Notify(NotificationSeverity.Success, "Success", "Course added successfully");
            dialogService.Close(true);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error adding course: {ex.Message}");
            NotificationService.Notify(NotificationSeverity.Error, "Error", "An error occurred while adding the course");
        }
        finally
        {
            isSubmitting = false;
        }
    }

    public class CourseViewModel
    {
        public string Code { get; set; } = string.Empty;
        public string Name { get; set; } = string.Empty;
        public string Description { get; set; } = string.Empty;
        public bool IsActive { get; set; } = true;
    }
}