@inject IUserService UserService
@inject NotificationService NotificationService

<RadzenTemplateForm TItem="StudentEditViewModel" Data="@model" Submit="@OnSubmit">
    <RadzenStack Gap="1rem">
        <RadzenFormField Text="First Name" Variant="Variant.Outlined">
            <RadzenTextBox @bind-Value="@model.FirstName" MaxLength="50" Name="FirstName" />
            <RadzenRequiredValidator Component="FirstName" Text="First name is required" />
        </RadzenFormField>

        <RadzenFormField Text="Last Name" Variant="Variant.Outlined">
            <RadzenTextBox @bind-Value="@model.LastName" MaxLength="50" Name="LastName" />
            <RadzenRequiredValidator Component="LastName" Text="Last name is required" />
        </RadzenFormField>

        <RadzenFormField Text="Email" Variant="Variant.Outlined">
            <RadzenTextBox @bind-Value="@model.Email" MaxLength="100" Disabled="true" Name="Email" />
        </RadzenFormField>

        <RadzenFormField Text="Student ID" Variant="Variant.Outlined">
            <RadzenTextBox @bind-Value="@model.StudentId" MaxLength="20" Name="StudentId" />
        </RadzenFormField>

        <RadzenFormField Text="Status" Variant="Variant.Outlined">
            <RadzenSwitch @bind-Value="@model.IsActive" Name="IsActive" />
            <RadzenText TextStyle="TextStyle.Caption" class="ms-2">
                @(model.IsActive ? "Active" : "Inactive")
            </RadzenText>
        </RadzenFormField>

        <RadzenStack Orientation="Orientation.Horizontal" Gap="1rem" JustifyContent="JustifyContent.End">
            <RadzenButton Text="Cancel" ButtonStyle="ButtonStyle.Light" Click="@(() => dialogService.Close(false))" />
            <RadzenButton Text="Update Student" ButtonStyle="ButtonStyle.Primary" ButtonType="ButtonType.Submit" IsBusy="@isSubmitting" />
        </RadzenStack>
    </RadzenStack>
</RadzenTemplateForm>

@code {
    [Parameter] public ApplicationUser Student { get; set; } = default!;
    [Inject] public DialogService dialogService { get; set; } = default!;
    [Inject] public UserManager<ApplicationUser> UserManager { get; set; } = default!;

    private StudentEditViewModel model = new();
    private bool isSubmitting;

    protected override void OnInitialized()
    {
        if (Student != null)
        {
            model.FirstName = Student.FirstName;
            model.LastName = Student.LastName;
            model.Email = Student.Email ?? string.Empty;
            model.StudentId = Student.StudentId ?? string.Empty;
            model.IsActive = Student.IsActive;
        }
    }

    private async Task OnSubmit()
    {
        try
        {
            isSubmitting = true;

            Student.FirstName = model.FirstName;
            Student.LastName = model.LastName;
            Student.StudentId = model.StudentId;
            Student.IsActive = model.IsActive;

            var result = await UserManager.UpdateAsync(Student);
            if (result.Succeeded)
            {
                NotificationService.Notify(NotificationSeverity.Success, "Success", "Student updated successfully");
                dialogService.Close(true);
            }
            else
            {
                NotificationService.Notify(NotificationSeverity.Error, "Error", "Failed to update student");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error updating student: {ex.Message}");
            NotificationService.Notify(NotificationSeverity.Error, "Error", "An error occurred while updating the student");
        }
        finally
        {
            isSubmitting = false;
        }
    }

    public class StudentEditViewModel
    {
        public string FirstName { get; set; } = string.Empty;
        public string LastName { get; set; } = string.Empty;
        public string Email { get; set; } = string.Empty;
        public string StudentId { get; set; } = string.Empty;
        public bool IsActive { get; set; } = true;
    }
}