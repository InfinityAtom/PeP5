@inject IExamService ExamService
@inject NotificationService NotificationService

<RadzenTemplateForm TItem="ExamCodeEditViewModel" Data="@model" Submit="@OnSubmit">
    <RadzenStack Gap="1rem">
        <RadzenFormField Text="Exam Code" Variant="Variant.Outlined">
            <RadzenTextBox Value="@ExamCode.Code" Disabled="true" Style="font-family: monospace; font-weight: bold;" Name="Code" />
            <RadzenText TextStyle="TextStyle.Caption" class="text-muted">
                Exam codes cannot be modified once created
            </RadzenText>
        </RadzenFormField>

        <RadzenFormField Text="Exam" Variant="Variant.Outlined">
            <RadzenTextBox Value="@ExamCode.Exam.Title" Disabled="true" Name="ExamTitle" />
        </RadzenFormField>

        <RadzenFormField Text="Description" Variant="Variant.Outlined">
            <RadzenTextBox @bind-Value="@model.Description" MaxLength="500" Name="Description" />
        </RadzenFormField>

        <RadzenFormField Text="Expires At" Variant="Variant.Outlined">
            <RadzenDatePicker @bind-Value="@model.ExpiresAt" DateFormat="MM/dd/yyyy HH:mm" ShowTime="true" Name="ExpiresAt" />
            <RadzenRequiredValidator Component="ExpiresAt" Text="Expiration date is required" />
        </RadzenFormField>

        <RadzenFormField Text="Maximum Uses" Variant="Variant.Outlined">
            <RadzenNumeric @bind-Value="@model.MaxUses" Min="1" Max="1000" Placeholder="Leave empty for unlimited" Name="MaxUses" />
            <RadzenText TextStyle="TextStyle.Caption" class="text-muted">
                Current uses: @ExamCode.TimesUsed
            </RadzenText>
        </RadzenFormField>

        <RadzenFormField Text="Active" Variant="Variant.Outlined">
            <RadzenSwitch @bind-Value="@model.IsActive" Name="IsActive" />
            <RadzenText TextStyle="TextStyle.Caption" class="ms-2">
                @(model.IsActive ? "Code is active" : "Code is inactive")
            </RadzenText>
        </RadzenFormField>

        <RadzenStack Orientation="Orientation.Horizontal" Gap="1rem" JustifyContent="JustifyContent.End">
            <RadzenButton Text="Cancel" ButtonStyle="ButtonStyle.Light" Click="@(() => dialogService.Close(false))" />
            <RadzenButton Text="Update Code" ButtonStyle="ButtonStyle.Primary" ButtonType="ButtonType.Submit" IsBusy="@isSubmitting" />
        </RadzenStack>
    </RadzenStack>
</RadzenTemplateForm>

@code {
    [Parameter] public ExamCode ExamCode { get; set; } = default!;
    [Inject] public DialogService dialogService { get; set; } = default!;
    [Inject] public ApplicationDbContext Context { get; set; } = default!;

    private ExamCodeEditViewModel model = new();
    private bool isSubmitting;

    protected override void OnInitialized()
    {
        if (ExamCode != null)
        {
            model.Description = ExamCode.Description ?? string.Empty;
            model.ExpiresAt = ExamCode.ExpiresAt;
            model.MaxUses = ExamCode.MaxUses;
            model.IsActive = ExamCode.IsActive;
        }
    }

    private async Task OnSubmit()
    {
        try
        {
            isSubmitting = true;

            ExamCode.Description = model.Description;
            ExamCode.ExpiresAt = model.ExpiresAt;
            ExamCode.MaxUses = model.MaxUses;
            ExamCode.IsActive = model.IsActive;

            await Context.SaveChangesAsync();

            NotificationService.Notify(NotificationSeverity.Success, "Success", "Exam code updated successfully");
            dialogService.Close(true);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error updating exam code: {ex.Message}");
            NotificationService.Notify(NotificationSeverity.Error, "Error", "An error occurred while updating the exam code");
        }
        finally
        {
            isSubmitting = false;
        }
    }

    public class ExamCodeEditViewModel
    {
        public string Description { get; set; } = string.Empty;
        public DateTime ExpiresAt { get; set; }
        public int? MaxUses { get; set; }
        public bool IsActive { get; set; } = true;
    }
}