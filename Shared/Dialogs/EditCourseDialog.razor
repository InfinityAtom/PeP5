@inject IExamService ExamService
@inject NotificationService NotificationService

<RadzenStack Gap="1rem" Style="min-width:450px;">
    <!-- Header -->
    <RadzenStack Gap="0.25rem" Style="border-bottom:1px solid var(--rz-base-300);padding-bottom:0.75rem;">
        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
            <RadzenIcon Icon="menu_book" Style="font-size:1.5rem;color:var(--rz-secondary);" />
            <RadzenText TextStyle="TextStyle.H6" TagName="TagName.H2" Style="margin:0;">Edit Course</RadzenText>
        </RadzenStack>
        <RadzenText TextStyle="TextStyle.Caption" class="text-muted">Update course details and availability status.</RadzenText>
    </RadzenStack>

    <RadzenTemplateForm TItem="CourseEditViewModel" Data="@model" Submit="@OnSubmit">
        <RadzenStack Gap="1rem">
            <!-- Course Details Card -->
            <RadzenCard Style="background:var(--rz-base-100);padding:1rem;">
                <RadzenStack Gap="0.75rem">
                    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                        <RadzenIcon Icon="info" Style="color:var(--rz-info);font-size:1.1rem;" />
                        <RadzenText TextStyle="TextStyle.Subtitle1" Style="margin:0;font-weight:500;">Course Details</RadzenText>
                    </RadzenStack>

                    <RadzenRow Style="row-gap:0.75rem;">
                        <RadzenColumn Size="12" SizeMD="4">
                            <RadzenFormField Text="Course Code" Variant="Variant.Outlined" Style="width:100%;">
                                <RadzenTextBox @bind-Value="@model.Code" MaxLength="20" Name="Code" Placeholder="e.g. CS101" Style="width:100%;" />
                            </RadzenFormField>
                        </RadzenColumn>
                        <RadzenColumn Size="12" SizeMD="8">
                            <RadzenFormField Text="Course Name" Variant="Variant.Outlined" Style="width:100%;">
                                <RadzenTextBox @bind-Value="@model.Name" MaxLength="200" Name="Name" Placeholder="Enter course name" Style="width:100%;" />
                                <RadzenRequiredValidator Component="Name" Text="Course name is required" />
                            </RadzenFormField>
                        </RadzenColumn>
                        <RadzenColumn Size="12">
                            <RadzenFormField Text="Description" Variant="Variant.Outlined" Style="width:100%;">
                                <RadzenTextArea @bind-Value="@model.Description" MaxLength="1000" Rows="3" Name="Description" Placeholder="Describe the course content and objectives..." Style="width:100%;" />
                            </RadzenFormField>
                        </RadzenColumn>
                    </RadzenRow>
                </RadzenStack>
            </RadzenCard>

            <!-- Status Card -->
            <RadzenCard Style="background:var(--rz-base-100);padding:1rem;">
                <RadzenStack Gap="0.75rem">
                    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                        <RadzenIcon Icon="toggle_on" Style="color:var(--rz-success);font-size:1.1rem;" />
                        <RadzenText TextStyle="TextStyle.Subtitle1" Style="margin:0;font-weight:500;">Availability</RadzenText>
                    </RadzenStack>

                    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween">
                        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.75rem">
                            <RadzenSwitch @bind-Value="@model.IsActive" Name="IsActive" />
                            <RadzenText TextStyle="TextStyle.Body2">Course Active</RadzenText>
                        </RadzenStack>
                        <RadzenBadge Text="@(model.IsActive ? "Active" : "Inactive")" BadgeStyle="@(model.IsActive ? BadgeStyle.Success : BadgeStyle.Danger)" />
                    </RadzenStack>
                    <RadzenText TextStyle="TextStyle.Caption" class="text-muted">
                        @(model.IsActive ? "Students can enroll in this course" : "Course is hidden from students")
                    </RadzenText>
                </RadzenStack>
            </RadzenCard>

            <!-- Action Buttons -->
            <RadzenStack Orientation="Orientation.Horizontal" Gap="0.75rem" JustifyContent="JustifyContent.End" Style="padding-top:0.5rem;border-top:1px solid var(--rz-base-300);">
                <RadzenButton Text="Cancel" Icon="close" ButtonStyle="ButtonStyle.Light" Click="@(() => dialogService.Close(false))" />
                <RadzenButton Text="Save Changes" Icon="save" ButtonStyle="ButtonStyle.Primary" ButtonType="ButtonType.Submit" IsBusy="@isSubmitting" Disabled="@isSubmitting" />
            </RadzenStack>
        </RadzenStack>
    </RadzenTemplateForm>
</RadzenStack>

@code {
    [Parameter] public Course Course { get; set; } = default!;
    [Inject] public DialogService dialogService { get; set; } = default!;
    [Inject] public ApplicationDbContext Context { get; set; } = default!;

    private CourseEditViewModel model = new();
    private bool isSubmitting;

    protected override void OnInitialized()
    {
        if (Course != null)
        {
            model.Code = Course.Code ?? string.Empty;
            model.Name = Course.Name;
            model.Description = Course.Description ?? string.Empty;
            model.IsActive = Course.IsActive;
        }
    }

    private async Task OnSubmit()
    {
        try
        {
            isSubmitting = true;

            Course.Code = model.Code;
            Course.Name = model.Name;
            Course.Description = model.Description;
            Course.IsActive = model.IsActive;

            await Context.SaveChangesAsync();

            NotificationService.Notify(NotificationSeverity.Success, "Success", "Course updated successfully");
            dialogService.Close(true);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error updating course: {ex.Message}");
            NotificationService.Notify(NotificationSeverity.Error, "Error", "An error occurred while updating the course");
        }
        finally
        {
            isSubmitting = false;
        }
    }

    public class CourseEditViewModel
    {
        public string Code { get; set; } = string.Empty;
        public string Name { get; set; } = string.Empty;
        public string Description { get; set; } = string.Empty;
        public bool IsActive { get; set; } = true;
    }
}
