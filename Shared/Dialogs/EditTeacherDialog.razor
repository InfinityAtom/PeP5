@inject IUserService UserService
@inject NotificationService NotificationService

<RadzenStack Gap="1rem" Style="min-width:450px;">
    <!-- Header -->
    <RadzenStack Gap="0.25rem" Style="border-bottom:1px solid var(--rz-base-300);padding-bottom:0.75rem;">
        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
            <RadzenIcon Icon="person" Style="font-size:1.5rem;color:var(--rz-primary);" />
            <RadzenText TextStyle="TextStyle.H6" TagName="TagName.H2" Style="margin:0;">Edit Teacher</RadzenText>
        </RadzenStack>
        <RadzenText TextStyle="TextStyle.Caption" class="text-muted">Update teacher profile information and account status.</RadzenText>
    </RadzenStack>

    <RadzenTemplateForm TItem="TeacherEditViewModel" Data="@model" Submit="@OnSubmit">
        <RadzenStack Gap="1rem">
            <!-- Personal Information Card -->
            <RadzenCard Style="background:var(--rz-base-100);padding:1rem;">
                <RadzenStack Gap="0.75rem">
                    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                        <RadzenIcon Icon="badge" Style="color:var(--rz-info);font-size:1.1rem;" />
                        <RadzenText TextStyle="TextStyle.Subtitle1" Style="margin:0;font-weight:500;">Personal Information</RadzenText>
                    </RadzenStack>

                    <RadzenRow Style="row-gap:0.75rem;">
                        <RadzenColumn Size="12" SizeMD="6">
                            <RadzenFormField Text="First Name" Variant="Variant.Outlined" Style="width:100%;">
                                <RadzenTextBox @bind-Value="@model.FirstName" MaxLength="50" Name="FirstName" Placeholder="First name" Style="width:100%;" />
                                <RadzenRequiredValidator Component="FirstName" Text="Required" />
                            </RadzenFormField>
                        </RadzenColumn>
                        <RadzenColumn Size="12" SizeMD="6">
                            <RadzenFormField Text="Last Name" Variant="Variant.Outlined" Style="width:100%;">
                                <RadzenTextBox @bind-Value="@model.LastName" MaxLength="50" Name="LastName" Placeholder="Last name" Style="width:100%;" />
                                <RadzenRequiredValidator Component="LastName" Text="Required" />
                            </RadzenFormField>
                        </RadzenColumn>
                        <RadzenColumn Size="12" SizeMD="6">
                            <RadzenFormField Text="Email Address" Variant="Variant.Outlined" Style="width:100%;">
                                <ChildContent>
                                    <RadzenTextBox @bind-Value="@model.Email" Disabled="true" Name="Email" Style="width:100%;background:var(--rz-base-200);" />
                                </ChildContent>
                                <Helper>
                                    <RadzenText TextStyle="TextStyle.Caption" class="text-muted">Email cannot be changed</RadzenText>
                                </Helper>
                            </RadzenFormField>
                        </RadzenColumn>
                        <RadzenColumn Size="12" SizeMD="6">
                            <RadzenFormField Text="Department" Variant="Variant.Outlined" Style="width:100%;">
                                <RadzenTextBox @bind-Value="@model.Department" MaxLength="100" Name="Department" Placeholder="e.g. Computer Science" Style="width:100%;" />
                            </RadzenFormField>
                        </RadzenColumn>
                    </RadzenRow>
                </RadzenStack>
            </RadzenCard>

            <!-- Account Status Card -->
            <RadzenCard Style="background:var(--rz-base-100);padding:1rem;">
                <RadzenStack Gap="0.75rem">
                    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                        <RadzenIcon Icon="verified_user" Style="color:var(--rz-success);font-size:1.1rem;" />
                        <RadzenText TextStyle="TextStyle.Subtitle1" Style="margin:0;font-weight:500;">Account Status</RadzenText>
                    </RadzenStack>

                    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween">
                        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.75rem">
                            <RadzenSwitch @bind-Value="@model.IsActive" Name="IsActive" />
                            <RadzenText TextStyle="TextStyle.Body2">Account Active</RadzenText>
                        </RadzenStack>
                        <RadzenBadge Text="@(model.IsActive ? "Active" : "Inactive")" BadgeStyle="@(model.IsActive ? BadgeStyle.Success : BadgeStyle.Danger)" />
                    </RadzenStack>
                </RadzenStack>
            </RadzenCard>

            <!-- Action Buttons -->
            <RadzenStack Orientation="Orientation.Horizontal" Gap="0.75rem" JustifyContent="JustifyContent.End" Style="padding-top:0.5rem;border-top:1px solid var(--rz-base-300);">
                <RadzenButton Text="Cancel" Icon="close" ButtonStyle="ButtonStyle.Light" Click="@(() => dialogService.Close(false))" />
                <RadzenButton Text="Save Changes" Icon="save" ButtonStyle="ButtonStyle.Primary" ButtonType="ButtonType.Submit" IsBusy="@isSubmitting" Disabled="@isSubmitting" />
            </RadzenStack>
        </RadzenStack>
    </RadzenTemplateForm>
</RadzenStack>

@code {
    [Parameter] public ApplicationUser Teacher { get; set; } = default!;
    [Inject] public DialogService dialogService { get; set; } = default!;
    [Inject] public UserManager<ApplicationUser> UserManager { get; set; } = default!;

    private TeacherEditViewModel model = new();
    private bool isSubmitting;

    protected override void OnInitialized()
    {
        if (Teacher != null)
        {
            model.FirstName = Teacher.FirstName;
            model.LastName = Teacher.LastName;
            model.Email = Teacher.Email ?? string.Empty;
            model.Department = Teacher.Department ?? string.Empty;
            model.IsActive = Teacher.IsActive;
        }
    }

    private async Task OnSubmit()
    {
        try
        {
            isSubmitting = true;

            Teacher.FirstName = model.FirstName;
            Teacher.LastName = model.LastName;
            Teacher.Department = model.Department;
            Teacher.IsActive = model.IsActive;

            var result = await UserManager.UpdateAsync(Teacher);
            if (result.Succeeded)
            {
                NotificationService.Notify(NotificationSeverity.Success, "Updated", "Teacher updated successfully");
                dialogService.Close(true);
            }
            else
            {
                NotificationService.Notify(NotificationSeverity.Error, "Error", string.Join("; ", result.Errors.Select(e => e.Description)));
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error updating teacher: {ex.Message}");
            NotificationService.Notify(NotificationSeverity.Error, "Error", "An error occurred while updating the teacher");
        }
        finally
        {
            isSubmitting = false;
        }
    }

    public class TeacherEditViewModel
    {
        public string FirstName { get; set; } = string.Empty;
        public string LastName { get; set; } = string.Empty;
        public string Email { get; set; } = string.Empty;
        public string Department { get; set; } = string.Empty;
        public bool IsActive { get; set; } = true;
    }
}
